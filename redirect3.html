<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ゴールド会員 決済へ移動中...</title>

  <!-- キャッシュ対策（LINE内で古いHTMLが残ることがある） -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body style="font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans JP',sans-serif; padding:16px;">
  <pre id="status" style="white-space:pre-wrap; word-break:break-word;">起動中...</pre>

  <script>
    // 画面に必ず出す（statusが取れなくても落ちない）
    function setStatus(msg) {
      try {
        const el = document.getElementById("status");
        if (el) el.textContent = msg;
      } catch (_) {}
    }

    // JSエラーを画面に出す（真っ白対策）
    window.addEventListener("error", (ev) => {
      setStatus("JSエラー:\n" + (ev?.message || ev));
    });
    window.addEventListener("unhandledrejection", (ev) => {
      setStatus("Promiseエラー:\n" + (ev?.reason?.message || ev?.reason || ev));
    });

    async function main() {
      // ★ リッチメニューのリンクと完全一致させる
      const LIFF_ID = "2008805355-pfJagaTF";

      // ★ Stripe Payment Link（ゴールド）
      const STRIPE_PAYMENT_LINK = "https://buy.stripe.com/8x23cw0cyeLNc2P708cQU05";

      setStatus("読み込みOK。\nURL:\n" + location.href);

      // ①「LIFFからのみアクセス」をコードで強制
      //    ※ブラウザ直叩き(GitHub Pages直アクセス)を弾く
      if (!window.liff) {
        setStatus("LIFF SDKが読み込めていません。通信環境を確認してください。");
        return;
      }

      // LINEアプリ内のLIFFブラウザ以外は止める
      // （あなたの要件「HTMLはLIFFからのみアクセス」）
      // ※もし“外部ブラウザでも動かしたい”なら、このブロックは外してください
      if (!liff.isInClient()) {
        setStatus("このページはLINEアプリ内（LIFF）からのみ開けます。\n\n開き方:\nリッチメニュー → ゴールド");
        return;
      }

      try {
        // ② LIFF初期化（1回だけ）
        setStatus("LIFF初期化中...");
        await liff.init({ liffId: LIFF_ID });

        // ③ 未ログインならログイン
        if (!liff.isLoggedIn()) {
          setStatus("LINEログイン中...");
          liff.login({ redirectUri: location.href });
          return;
        }

        // ④ userId取得
        setStatus("プロフィール取得中...");
        const profile = await liff.getProfile();

        // ⑤ Stripe URL生成
        const url = new URL(STRIPE_PAYMENT_LINK);
        url.searchParams.set("client_reference_id", profile.userId);

        // ⑥ 外部ブラウザでStripeを開く（external:true）
        setStatus("決済画面を外部ブラウザで開きます...\n" + url.toString());
        liff.openWindow({
          url: url.toString(),
          external: true
        });

        // （任意）開いたらLIFF画面を閉じるなら：
        // setTimeout(() => liff.closeWindow(), 300);

      } catch (e) {
        console.error(e);
        setStatus("エラー:\n" + (e?.message || JSON.stringify(e)));
      }
    }

    window.addEventListener("load", main);
  </script>
</body>
</html>
